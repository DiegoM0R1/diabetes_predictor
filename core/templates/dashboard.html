<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Resultados - Predictor de Diabetes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 40px 0;
        }
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        .section {
            background: rgba(255, 255, 255, 0.95);
            margin: 20px 0;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        .section h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 2rem;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        .metric-box {
            text-align: center;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .metric-box h4 {
            color: #1976d2;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1976d2;
        }
        .metric-description {
            font-size: 0.9rem;
            color: #777;
            margin-top: 5px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 30px auto;
            background: #f9f9f9;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            padding: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table th, table td {
            padding: 10px;
            border: 1px solid #dee2e6;
            text-align: center;
        }
        table th {
            background: #f8f9fa;
            color: #4a5568;
        }
        .confusion-matrix-table td {
            font-weight: bold;
        }
        .confusion-matrix-table .correct {
            background-color: #e8f5e8; /* Light green */
            color: #28a745;
        }
        .confusion-matrix-table .incorrect {
            background-color: #ffebee; /* Light red */
            color: #dc3545;
        }
        .conclusion-point {
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .conclusion-point strong {
            color: #667eea;
        }
        .nav-buttons {
            margin-top: 25px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        .nav-button {
            background: linear-gradient(45deg, #007bff, #0056b3); /* Azul */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-decoration: none; /* Para que parezca un bot贸n */
            display: inline-block;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 123, 255, 0.4);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            .grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 300px;
            }
            .metric-value {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-buttons" style="margin-bottom: 30px;">
            <a href="{% url 'upload_csv' %}" class="nav-button">Cargar Nuevo CSV</a>
        </div>

        <div class="header">
            <h1> Dashboard de Resultados del Modelo de Diabetes</h1>
            <p>An谩lisis Profesional de la Detecci贸n Temprana de Diabetes con Deep Learning</p>
        </div>

        <div class="section">
            <h2>M茅tricas Clave del Modelo</h2>
            <p>Estas son las m茅tricas de rendimiento obtenidas en el conjunto de datos de prueba. Nos indican la **precisi贸n y fiabilidad** de nuestro modelo para predecir la diabetes en pacientes no vistos previamente. Un profesional se enfoca en entender las implicaciones de cada una.</p>
            <div class="grid">
                <div class="metric-box">
                    <h4>AUC</h4>
                    <div class="metric-value" id="auc_value">0.87</div>
                    <p class="metric-description">rea bajo la curva ROC. Cuanto m谩s cerca de 1, mejor es la capacidad del modelo para distinguir entre clases.</p>
                </div>
                <div class="metric-box">
                    <h4>Precisi贸n (Accuracy)</h4>
                    <div class="metric-value" id="accuracy_value">82.00%</div>
                    <p class="metric-description">Porcentaje de predicciones correctas. Una buena medida general, pero no la 煤nica importante.</p>
                </div>
                <div class="metric-box">
                    <h4>F1-Score</h4>
                    <div class="metric-value" id="f1_score_value">0.79</div>
                    <p class="metric-description">Balance entre precisi贸n y recall. Fundamental en salud para asegurar que no omitimos casos de diabetes.</p>
                </div>
                <div class="metric-box">
                    <h4>LogLoss</h4>
                    <div class="metric-value" id="logloss_value">0.45</div>
                    <p class="metric-description">Mide la incertidumbre de las predicciones de probabilidad. Un valor m谩s bajo indica mayor confianza.</p>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>An谩lisis de la Matriz de Confusi贸n</h2>
            <p>La **Matriz de Confusi贸n** es una herramienta esencial para entender los **errores espec铆ficos** de nuestro modelo. Nos permite visualizar los **Verdaderos Positivos y Negativos**, y, crucialmente, los **Falsos Positivos y Falsos Negativos**, que tienen implicaciones directas en la vida de los pacientes.</p>
            <div class="chart-container">
                <canvas id="confusionMatrixChart"></canvas>
            </div>
            <table class="confusion-matrix-table">
                <thead>
                    <tr>
                        <th></th>
                        <th>Predicho: No Diab茅tico (0)</th>
                        <th>Predicho: Diab茅tico (1)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>**Real: No Diab茅tico (0)**</td>
                        <td class="correct" id="tn_value"></td>
                        <td class="incorrect" id="fp_value"></td>
                    </tr>
                    <tr>
                        <td>**Real: Diab茅tico (1)**</td>
                        <td class="incorrect" id="fn_value"></td>
                        <td class="correct" id="tp_value"></td>
                    </tr>
                </tbody>
            </table>
            <p style="font-size: 0.9rem; color: #777; margin-top: 15px;">
                <strong>Verdaderos Positivos (VP):</strong> Pacientes diab茅ticos correctamente identificados.<br>
                <strong>Verdaderos Negativos (VN):</strong> Pacientes no diab茅ticos correctamente identificados.<br>
                <strong>Falsos Positivos (FP):</strong> Pacientes sanos err贸neamente diagnosticados como diab茅ticos (causa ansiedad, pruebas innecesarias).<br>
                <strong>Falsos Negativos (FN):</strong> Pacientes diab茅ticos err贸neamente diagnosticados como sanos (隆la mayor preocupaci贸n, se pierde una intervenci贸n temprana!).
            </p>
        </div>

        <div class="section">
            <h2>Curva ROC: El Poder Discriminatorio del Modelo</h2>
            <p>La **Curva ROC (Receiver Operating Characteristic)** nos muestra la capacidad de nuestro modelo para distinguir entre pacientes diab茅ticos y no diab茅ticos a trav茅s de diferentes umbrales de decisi贸n. Un 谩rea grande bajo la curva (AUC) indica un modelo robusto.</p>
            <div class="chart-container">
                <canvas id="rocCurveChart"></canvas>
            </div>
            <p style="font-size: 0.9rem; color: #777;">
                Una curva que se acerca a la esquina superior izquierda indica un modelo con alta sensibilidad (detecta bien a los verdaderos positivos) y alta especificidad (evita los falsos positivos). La l铆nea diagonal punteada representa un clasificador aleatorio, que queremos superar con creces.
            </p>
        </div>

        <div class="section">
            <h2>Distribuci贸n de Clases en los Datos</h2>
            <p>Entender la distribuci贸n original de los datos nos ayuda a interpretar el rendimiento del modelo. Los modelos pueden tener dificultades si una clase est谩 muy subrepresentada (desequilibrio de clases).</p>
            <div class="chart-container" style="height: 300px;">
                <canvas id="classDistributionChart"></canvas>
            </div>
        </div>

        <div class="section">
            <h2>Conclusiones Profesionales y Pr贸ximos Pasos</h2>
            <div class="conclusion-point">
                <strong>Precisi贸n y Confianza:</strong> Los resultados demuestran que el modelo de Deep Learning tiene una capacidad significativa para predecir la diabetes. El AUC alto es un indicador de que el modelo es robusto en su discriminaci贸n.
            </div>
            <div class="conclusion-point">
                <strong>Identificaci贸n de Desaf铆os:</strong> Un an谩lisis detallado de la Matriz de Confusi贸n nos permite identificar 谩reas de mejora, especialmente la reducci贸n de Falsos Negativos, que son de alta prioridad cl铆nica.
            </div>
            <div class="conclusion-point">
                <strong>Iteraci贸n Continua:</strong> En un entorno profesional, este no es el fin del proceso, sino el comienzo. Se realizar铆an m谩s experimentos: optimizaci贸n de hiperpar谩metros, uso de m谩s datos, t茅cnicas de ingenier铆a de caracter铆sticas, y la incorporaci贸n de la opini贸n de expertos m茅dicos.
            </div>
            <div class="conclusion-point">
                <strong>Validaci贸n Cl铆nica:</strong> Antes de cualquier implementaci贸n real, el modelo debe someterse a rigurosas validaciones cl铆nicas y pruebas con datos de pacientes reales y nuevos, siempre con supervisi贸n m茅dica. La transparencia y la explicabilidad del modelo son clave.
            </div>
        </div>
        <div class="nav-buttons">
            <a href="{% url 'upload_csv' %}" class="nav-button">Cargar Nuevo CSV</a>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Predictor de Diabetes con IA. Desarrollado con responsabilidad profesional.</p>
        <p>Los resultados de este dashboard son de un modelo de demostraci贸n y no constituyen un diagn贸stico m茅dico.</p>
    </footer>

    <script>
        const dashboardDataElement = document.getElementById('dashboard_data_json');
        let dashboardData = null;

        if (dashboardDataElement && dashboardDataElement.textContent) {
            try {
                dashboardData = JSON.parse(dashboardDataElement.textContent);
                console.log("Datos del Dashboard:", dashboardData);
            } catch (e) {
                console.error("Error al parsear JSON del dashboard:", e);
                // Si hay un error al parsear, mostramos un mensaje amigable
                document.querySelector('.container').innerHTML = `
                    <h1>Error al cargar Dashboard</h1>
                    <p>Hubo un problema al procesar los resultados del modelo. Por favor, <a href="/">cargue un CSV</a> e intente de nuevo.</p>
                `;
            }
        }

        if (dashboardData) {
            // Actualizar m茅tricas
            document.getElementById('auc_value').textContent = dashboardData.metrics.auc.toFixed(2);
            document.getElementById('accuracy_value').textContent = dashboardData.metrics.accuracy.toFixed(2) + '%';
            document.getElementById('f1_score_value').textContent = dashboardData.metrics.f1_score.toFixed(2);
            document.getElementById('logloss_value').textContent = dashboardData.metrics.logloss.toFixed(2);

            // Actualizar matriz de confusi贸n
            const cmData = dashboardData.confusion_matrix.data;
            if (cmData && cmData.length === 2 && cmData[0].length === 2) {
                document.getElementById('tn_value').textContent = cmData[0][0]; // True Negative
                document.getElementById('fp_value').textContent = cmData[0][1]; // False Positive
                document.getElementById('fn_value').textContent = cmData[1][0]; // False Negative
                document.getElementById('tp_value').textContent = cmData[1][1]; // True Positive
            } else {
                 document.getElementById('tn_value').textContent = 'N/A';
                 document.getElementById('fp_value').textContent = 'N/A';
                 document.getElementById('fn_value').textContent = 'N/A';
                 document.getElementById('tp_value').textContent = 'N/A';
            }


            // Gr谩fico de Matriz de Confusi贸n
            const cmChartCtx = document.getElementById('confusionMatrixChart').getContext('2d');
            new Chart(cmChartCtx, {
                type: 'bar',
                data: {
                    labels: ['No Diab茅tico Real', 'Diab茅tico Real'],
                    datasets: [
                        {
                            label: 'Predicho: No Diab茅tico',
                            data: [cmData[0][0], cmData[1][0]], // TN, FN
                            backgroundColor: ['#e8f5e8', '#ffebee'], // Green for TN, Red for FN
                            borderColor: ['#28a745', '#dc3545'],
                            borderWidth: 1
                        },
                        {
                            label: 'Predicho: Diab茅tico',
                            data: [cmData[0][1], cmData[1][1]], // FP, TP
                            backgroundColor: ['#ffebee', '#e8f5e8'], // Red for FP, Green for TP
                            borderColor: ['#dc3545', '#28a745'],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Matriz de Confusi贸n Visualizada'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Real'
                            }
                        },
                        y: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Conteo de Pacientes'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Gr谩fico de Curva ROC (Simulado para demostraci贸n)
            const rocChartCtx = document.getElementById('rocCurveChart').getContext('2d');
            const fpr_data = [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0];
            const tpr_data = [0.0, 0.4, 0.65, 0.8, 0.88, 0.92, 0.95, 0.97, 0.98, 0.99, 1.0]; // Datos de TPR simulados para un AUC de 0.87
            
            new Chart(rocChartCtx, {
                type: 'line',
                data: {
                    labels: fpr_data, // FPR es el eje X
                    datasets: [
                        {
                            label: 'Curva ROC (AUC = ' + dashboardData.metrics.auc.toFixed(2) + ')',
                            data: tpr_data, // TPR es el eje Y
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            fill: true,
                            tension: 0.2,
                            pointRadius: 0
                        },
                        {
                            label: 'Clasificador Aleatorio',
                            data: fpr_data, // FPR = TPR para clasificador aleatorio
                            borderColor: '#dc3545',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Curva ROC (Receiver Operating Characteristic)'
                        },
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Tasa de Falsos Positivos (FPR)'
                            },
                            min: 0,
                            max: 1
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Tasa de Verdaderos Positivos (TPR)'
                            },
                            min: 0,
                            max: 1
                        }
                    }
                }
            });

            // Gr谩fico de Distribuci贸n de Clases
            const classDistCtx = document.getElementById('classDistributionChart').getContext('2d');
            new Chart(classDistCtx, {
                type: 'doughnut',
                data: {
                    labels: dashboardData.class_distribution.labels.map((label, i) => `${label} (${dashboardData.class_distribution.data[i]})`),
                    datasets: [{
                        data: dashboardData.class_distribution.data,
                        backgroundColor: ['#667eea', '#764ba2'],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribuci贸n de Clases en el Dataset Completo'
                        },
                        legend: {
                            position: 'bottom'
                        },
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed) {
                                        // Extraer solo el n煤mero de la etiqueta para el c谩lculo del porcentaje
                                        const value = parseInt(label.match(/\((\d+)\)/)[1]);
                                        const total = dashboardData.class_distribution.data.reduce((sum, val) => sum + val, 0);
                                        label = label.replace(/\(\d+\)/, '') + `(${value} - ${((value / total) * 100).toFixed(1)}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

        } else {
            // Manejar caso donde no hay datos a煤n (ej. recarga la p谩gina antes de entrenar)
            document.querySelector('.container').innerHTML = `
                <h1>Dashboard No Disponible</h1>
                <p>A煤n no se ha entrenado un modelo. Por favor, <a href="/">cargue un CSV</a> para iniciar el proceso.</p>
            `;
        }
    </script>
</body>
</html>